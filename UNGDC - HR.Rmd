---
title: "UNGDC"
author: "JGUP"
date: "10/10/2019"
output: html_document
---

```{r setup, include=FALSE}
library(zip)
```

### PTS and UNGDC data

```{r}
#filelist <- list.files(path = root_folder, pattern = '*.txt', recursive = TRUE)
#filenames <- basename(filelist)
#ungdc_files <- data.frame(t(sapply(strsplit(filenames, '_'), 
#                 function(x) c(x[1], x[2], substr(x[3], 1, 4)))))
#colnames(ungdc_files) <- c('country', 'number', 'year')
#ungdc_files$text <- sapply(paste0(root_folder, filelist), function(x) readChar(x, file.info(x)$size))
#load(url("http://www.politicalterrorscale.org/Data/Files/PTS-2019.RData"))
```

# tadaproject
Human Rights in the UNGA

Using the code of the  The Lancet Countdown report: Nick Watts et al. (2018). "The 2018 report of the Lancet Countdown on health and climate change: shaping the health of nations for centuries to come." The Lancet, 392(10163): 2479-2514. With the UNGA Corpus.

#Data

#Loading data from the UNGDC data

```{r message=FALSE}
#Loading packages and data
library(readtext)
library(quanteda)
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(rworldmap)
library(RColorBrewer)
library(haven)
library(readxl)
```

### UNGDC data
```{r}
#Upload UNGDC data
dir.create(temp <- tempfile())
urlungdc<-'https://dataverse.harvard.edu/api/access/datafile/:persistentId?persistentId=doi:10.7910/DVN/0TJX8Y/PZUURT'

download.file(urlungdc, paste0(temp, '/PZUURT.zip'), mode="wb",
              exdir = temp)

unzip(paste0(temp, '/PZUURT.zip'), exdir = temp)

ungd_files <- readtext(paste0(temp, "/Converted sessions/*"),
                       docvarsfrom = "filenames", 
                       dvsep="_", 
                       docvarnames = c("Country", "Session", "Year"))

head(ungd_files)

ungd_files$doc_id <- str_replace(ungd_files$doc_id , ".txt", "") %>%
   str_replace(. , "_\\d{2}", "")

unlink(temp)

rm(temp)
#rm(filelist)
#rm(filenames)
rm(urlungdc)
```

```{r}
head(ungd_files)
```



### PTS data
```{r}
load(url("http://www.politicalterrorscale.org/Data/Files/PTS-2019.RData"))
PTS_2019<-arrange(PTS_2019,Country,Year)

PTS_2019<-PTS_2019 %>% 
  group_by(Country) %>% 
  mutate(.,PTS_S_ch=c(NA,diff(PTS_S)))

PTS_2019<-mutate(PTS_2019,PTS_S_var= ifelse(PTS_S_ch>0,1,0))

PTS_2019<-PTS_2019 %>% 
  group_by(Country) %>% 
  mutate(.,PTS_H_ch=c(NA,diff(PTS_H)))

PTS_2019<-mutate(PTS_2019,PTS_H_var= ifelse(PTS_H_ch>0,1,0))

PTS_2019<-PTS_2019 %>% 
  group_by(Country) %>% 
  mutate(.,PTS_A_ch=c(NA,diff(PTS_A)))

PTS_2019<-mutate(PTS_2019,PTS_A_var= ifelse(PTS_A_ch>0,1,0))
```


### Merging the datasets UNGD and PTS

```{r}
install.packages("compareDF")

library(compareDF)
```

```{r}
#compare years
PTS_2019 %>%
      group_by(Year) %>%
      summarise(n = n())

ungd_files %>%
      group_by(Year) %>%
      summarise(n = n())
```

```{r}
#compare country
colnames(ungd_files)[colnames(ungd_files)=="Country"] <- "MergeCountry"
colnames(PTS_2019)[colnames(PTS_2019)=="WordBank_Code_A"] <- "MergeCountry"

PTS_2019 %>%
      group_by(MergeCountry) %>%
      summarise(n = n())

ungd_files %>%
      group_by(MergeCountry) %>%
      summarise(n = n())

merge_PTS_ungd <- merge(PTS_2019, ungd_files, by = c('Year','MergeCountry'), all=TRUE)

merge_PTS_ungd1976 <- subset(merge_PTS_ungd, !merge_PTS_ungd$Year<1976)

NA_PTS_ungd1976 <- subset(merge_PTS_ungd1976, is.na(merge_PTS_ungd1976$MergeCountry))

mergeNA_PTS_ungd_1976 <- subset(merge_PTS_ungd1976, !is.na(merge_PTS_ungd1976$MergeCountry))

head(mergeNA_PTS_ungd_1976)
tail(mergeNA_PTS_ungd_1976)
```

```{r}
#Deleting NAs in the text - speeches rows from the "mergeNA_PTS_ungd_1976"
clean_PTS_ungd1976 <- subset(mergeNA_PTS_ungd_1976, !is.na(mergeNA_PTS_ungd_1976$text))
```

##Creating corpus object: clean ungd merged corpus for regression analysis
```{r}
ungd_corpus <- corpus(clean_PTS_ungd1976, text_field = "text") 

# ungdc.1990 <- corpus_subset(ungd_corpus, Year>1990)
```

#Pre-processing

Tokenizing corpus.

```{r}
#Tokenization and basic pre-processing

toks_UNGD <- tokens(ungd_corpus, what = "word",
              remove_punct = TRUE,
              remove_symbols = TRUE,
              remove_numbers = TRUE,
              remove_twitter = TRUE,
              remove_url = TRUE,
              remove_hyphens = FALSE,
              verbose = TRUE, 
              include_docvars = TRUE)
```

```{r}
lower_UNGD <- tokens_tolower(toks_UNGD)

stop_UNGD <- tokens_select(lower_UNGD, stopwords("english"), selection = "remove", padding = FALSE)

ngram_UNGD <- tokens(stop_UNGD, ngrams = c(1:2), include_docvars = TRUE)
head(ngram_UNGD)
```

```{r}
#head(lower_UNGD)
```

#Dictionary Analysis HR binary
## 1. Identifying the frequency of usage of "Human Rights" in UN Speeches

Creating compound tokens from the "Human Rights" concept:

```{r}
listHHRR <- list( c("Human", "Rights")) 
```

```{r}
listHHRR
```

```{r}
compound_UNGD_HHRR <- tokens_compound(lower_UNGD, listHHRR, valuetype = "fixed", concatenator = "_")
```

Creating a Dictionary of Human Rights, in order to identify the frequency of the concept in UNGD Speeches:

```{r}
HHRR_dict <- dictionary(list(Human.Rights=c("Human Rights")))
HHRR_dict
```

## Look up Human Rights term counts

Looking up and counting the frequency of usage of "Human Rights" in the UN GA speeches.

--> Apply a dictionary (HHRR) to a dfm by looking up all dfm features for matches in a a set of dictionary values.

```{r}
dfm_UNGD_HHRR <- dfm(compound_UNGD_HHRR)
HHRR_dfm <- dfm_lookup(dfm_UNGD_HHRR, HHRR_dict, valuetype = "fixed")
```

```{r}
head(HHRR_dfm)
```

Data Frame of human rights variables in UNGDC

```{r}
#creating a data frame 
Human.Rights_HHRR <- convert(HHRR_dfm, to = "data.frame")

#converting documentID into two columns - country and year
HHRR_counts <- Human.Rights_HHRR %>%
  separate(document, c("country", "year"), "_")

#year as numeric
HHRR_counts$year <- as.numeric(HHRR_counts$year)
HHRR_counts <- plyr::rename(HHRR_counts, c("Human.Rights"="HHRR"))
```

```{r}
head(HHRR_counts)
```


```{r}
#Merge HHRR counts with the MergeNA_PTS_ungd_1976 data set

colnames(HHRR_counts)[colnames(HHRR_counts)=="country"] <- "MergeCountry"
colnames(HHRR_counts)[colnames(HHRR_counts)=="year"] <- "Year"
head(HHRR_counts)

colnames(clean_PTS_ungd1976)[colnames(clean_PTS_ungd1976)=="MergeCountry"] <- "MergeCountry"
head(clean_PTS_ungd1976)

clean_PTS_ungd1976 %>%
      group_by(MergeCountry) %>%
      summarise(n = n())

HHRR_counts %>%
      group_by(MergeCountry) %>%
      summarise(n = n())

merge_HHRRcounts <- merge(clean_PTS_ungd1976, HHRR_counts, by = c('MergeCountry','Year'), all=TRUE)

head(merge_HHRRcounts)
```


#Baseline

## Model 1. Relation between changes in PTS and mentions of the "Human Rights" concept in UNGD speeches

```{r}
install.packages("texreg")
install.packages("lmtest")
```


```{r}
library(foreign)
library(texreg)
library(lmtest)
```

Linear regression model between changes in PTS (State Department) and mentions of the "Human Rights" concept in UNGD speeches (1976 - 2018)

```{r}
ModelHHRR_S <- lm (HHRR ~ PTS_S + PTS_S_ch + PTS_S*PTS_S_ch, data = merge_HHRRcounts)
screenreg(ModelHHRR)
#PTS_S significant and negative

ModelHHRR_A <- lm (HHRR ~ PTS_A + PTS_A_ch + PTS_A*PTS_A_ch, data = merge_HHRRcounts)
screenreg(ModelHHRR_A)
#PTS_A significant and negative

ModelHHRR_H <- lm (HHRR ~ PTS_H + PTS_H_ch + PTS_H*PTS_H_ch, data = merge_HHRRcounts)
screenreg(ModelHHRR_H)
#PTS_H insignificant
```



###Model Regressoin with sophisticated human rights dictionary
### Create Human Rights Dictionary

```{r}
#create human rights lists from the three sources

HRlistFariss <- list( c("kill"), c("forc"), c("arm"), c("group"), c("civilian"), c("human"), c("secur"), c("disappear"), c("attack"), c("execut") , c("tortur"), c("member"), c("includ"), c("arrest"), c("prison"), c("polit"), c("amnesti"), c("trial"), c("releas"), c("imprison"), c("sentenc"), c("charg"), c("conscience"), c("polic"), c("offic"), c("illtreat"), c("death"), c("court"), c("alleg"), c("law"), c("service"), c("concern"), c("appeal"), c("servic"), c("committee"),    c("militari"), c("area"), c("continu"), c("section"), c("state"), c("dure"), c("arrest"), c("accord"), c("offici"), c("presid"), c("opposit"), c("howev"), c("parti"), c("author"), c("law"), c("provid"), c("gener"), c("public"), c("constitut"), c("employ"), c("women"), c("right"), c("respect"), c("freedom"), c("prohibit"), c("case"), c("ngo"), c("tortur"), c("gener"), c("labor"), c("detain"), c("releas"), c("elect"), c("local"), c("presidenti"), c("region"), c("mani"), c("regim"), c("nation"), c("ethnic"), c("union"), c("practic"), c("work"), c("foreign"), c("children"), c("investig"), c("relig"), c("islam"), c("roma"), c("worker"), c("traffic"), c("feder"), c("parliament"))

HRlistGreene <- list(c("committed"), c("victims"), c("populations"), c("scale"), c("armed"), c("army"), c("commanders"), c("conscripted"), c("assassinations"), c("massacres"), c("internally", "displaced"), c("food"), c("humanitarian"), c("landmines"), c("money"), c("raped"), c("disappearances"), c("frequently"), c("numerous"), c("widespread"), c("common"), c("regularly"), c("routinely"), c("systematic"), c("extensive"))

HRlistWatanabe <- list(c("human", "rights"), c("violat"), c("race"), c("dignit"), c("protect"), c("citizen"), c("educat"), c("child"), c("refugee"), c("communit"), c("people"), c("responsibl"), c("health"), c("world"))

HRlist <- do.call(c, list(HRlistFariss, HRlistGreene, HRlistWatanabe))
#summary(HRlist)

```

Creating compound tokens from the "Human Rights" concept:

```{r}
compound_UNGD_HRlist <- tokens_compound(lower_UNGD, HRlist, valuetype = "fixed", concatenator = "_")
#compound_UNGD_HRlist
```

#create dictionaries from the three sources

```{r}
dict_HRFariss <- dictionary(list(human_rightsF = c("kill", "forc", "arm", "group", "civilian", "human", "secur", "disappear", "attack", "execut" , "tortur", "member", "includ", "arrest", "prison", "polit", "amnesti", "trial", "releas", "imprison", "sentenc", "charg", "conscience", "polic", "offic", "illtreat", "death", "court", "alleg", "law", "service", "concern", "appeal", "servic", "committee", "militari", "area", "continu", "section", "state", "dure", "arrest", "offici", "presid", "opposit", "parti", "author", "law", "provid", "gener", "public", "constitut", "employ", "women", "right", "respect", "freedom", "prohibit", "case", "ngo", "tortur", "gener", "labor", "detain", "releas", "elect", "local", "presidenti", "region", "mani", "regim", "nation", "ethnic", "union", "practic", "work", "foreign", "children", "investig", "relig", "islam", "roma", "worker", "traffic", "feder", "parliament")))

dict_HRGreene <- dictionary(list(human_rightsG = c("commit", "victim", "popul", "scale", "armi", "command", "conscript", "assassin", "massacr", "intern_displac", "food", "humanitarian", "landmin", "money", "rape", "disappear", "widespread", "systemat", "extens")))

#checking the stemmed version of dict_HRGreene
char_HRGreene <- as.character(dict_HRGreene)
toks_HRGreene <- tokens(char_HRGreene)
toks_HRGreene
remove_HRGreene <- tokens(toks_HRGreene, remove_punct = TRUE)
remove_HRGreene
tokens_wordstem(remove_HRGreene)

dict_HRWatanabe <- dictionary(list(human_rightsW = c("human_rights", "violat", "race", "dignit", "protect", "citizen", "educat", "child", "refugee", "communit", "people", "responsibl", "health", "world")))

#combine the dictionaries
HRdict <- c(dict_HRGreene["human_rightsG"], dict_HRFariss["human_rightsF"], dict_HRWatanabe["human_rightsW"])

#one complete dictionary
HRdict_total <- dictionary(list(human_rights_total = c("kill", "forc", "arm", "group", "civilian", "human", "secur", "disappear", "attack", "execut" , "tortur", "member", "includ", "arrest", "prison", "polit", "amnesti", "trial", "releas", "imprison", "sentenc", "charg", "conscience", "polic", "offic", "illtreat", "death", "court", "alleg", "law", "service", "concern", "appeal", "servic", "committee", "militari", "area", "continu", "section", "state", "dure", "arrest", "offici", "presid", "opposit", "parti", "author", "law", "provid", "gener", "public", "constitut", "employ", "women", "right", "respect", "freedom", "prohibit", "case", "ngo", "tortur", "gener", "labor", "detain", "releas", "elect", "local", "presidenti", "region", "mani", "regim", "nation", "ethnic", "union", "practic", "work", "foreign", "children", "investig", "relig", "islam", "roma", "worker", "traffic", "feder", "parliament", "commit", "victim", "popul", "scale", "armi", "command", "conscript", "assassin", "massacr", "intern_displac", "food", "humanitarian", "landmin", "money", "rape", "disappear", "widespread", "systemat", "extens", "human_rights", "violat", "race", "dignit", "protect", "citizen", "educat", "child", "refugee", "communit", "people", "responsibl", "health", "world")))

```

#Dictionary Analysis HR binary
## 1. Identifying the frequency of usage of "Human Rights" in UN Speeches

```{r}
HRdict
HRdict_total
```

## Look up Human Rights dictionary counts

Looking up and counting the frequency of usage of "Human Rights" in the UN GA speeches.

--> Apply a dictionary (HHRR) to a dfm by looking up all dfm features for matches in a a set of dictionary values.

```{r}
dfm_UNGD_HR <- dfm(compound_UNGD_HRlist)
#combined dict
HR_dfm <- dfm_lookup(dfm_UNGD_HR, HRdict, valuetype = "fixed")
#total dict
HR_dfm_total <- dfm_lookup(dfm_UNGD_HR, HRdict_total, valuetype = "fixed")

```

```{r}
head(HR_dfm)
head(HR_dfm_total)
```

Data Frame of human rights variables in UNGDC

```{r}
#creating a data frame 
Human.Rights_HR <- convert(HR_dfm_total, to = "data.frame")

#converting documentID into two columns - country and year
HR_counts <- Human.Rights_HR %>%
  separate(document, c("country", "year"), "_")

#year as numeric
HR_counts$year <- as.numeric(HR_counts$year)
head(HR_counts)
HR_counts <- plyr::rename(HR_counts, c("human_rights_total"="HR"))
```

```{r}
head(HR_counts)
```


```{r}
#Merge total HR dictionary counts with the MergeNA_PTS_ungd_1976 data set

colnames(HR_counts)[colnames(HR_counts)=="country"] <- "MergeCountry"
colnames(HR_counts)[colnames(HR_counts)=="year"] <- "Year"
head(HR_counts)

colnames(merge_HHRRcounts)[colnames(merge_HHRRcounts)=="MergeCountry"] <- "MergeCountry"
head(merge_HHRRcounts)

merge_HHRRcounts %>%
      group_by(MergeCountry) %>%
      summarise(n = n())

HR_counts %>%
      group_by(MergeCountry) %>%
      summarise(n = n())

merge_HRdict_counts <- merge(merge_HHRRcounts, HR_counts, by = c('MergeCountry','Year'), all=TRUE)

head(merge_HRdict_counts)
#merged dataset with both dictionaries: HHRRterm and HRdict
```


#Sophisticated Human Rights Dictionary Model

## Model 2. Relation between changes in PTS and mentions of the features within the human rights dictionary in UNGD speeches

Linear regression model between changes in PTS (State Department) and mentions of the "Human Rights" concept in UNGD speeches (1976 - 2018)

```{r}
ModelHRdict_S <- lm (HR ~ PTS_S + PTS_S_ch + PTS_S*PTS_S_ch, data = merge_HRdict_counts)
screenreg(ModelHRdict_S)

ModelHRdict_A <- lm (HR ~ PTS_A + PTS_A_ch + PTS_A*PTS_A_ch, data = merge_HRdict_counts)
screenreg(ModelHRdict_A)

ModelHRdict_H <- lm (HR ~ PTS_H + PTS_H_ch + PTS_H*PTS_H_ch, data = merge_HRdict_counts)
screenreg(ModelHRdict_H)
```


###Hypothesis 2: sentiment dictionary analysis

### add Syuzhet dictionary (#added from Nina branch)

```{r}
install.packages("syuzhet")
install.packages("devtools")
install.packages("pander")
devtools::install_github("mjockers/syuzhet")
1
library(syuzhet)
library(pander)
```

```{r}
#get sentiment analysis with four different dictionaries: syuzhet (1), afinn, bing, and nrc

#1: Create vectors for the sentiment dictionaries: syuzhet is mixed, bing is binary neg/pos, afinn is a scale and nrc has different emptional categories
sent_syuzhet <- get_sentiment(stop_UNGD, method ="syuzhet")
sent_afinn <- get_sentiment(stop_UNGD, method ="afinn")
sent_bing <- get_sentiment(stop_UNGD, method ="bing")
sent_nrc <- get_sentiment(stop_UNGD, method ="nrc", lang = "english")

dict_bing <- get_sentiment_dictionary(dictionary = "bing")
dict_syuzhet <- get_sentiment_dictionary(dictionary = "syuzhet")
dict_afinn <- get_sentiment_dictionary(dictionary = "afinn")
dict_nrc <- get_sentiment_dictionary(dictionary = "nrc", lang = "english")

#2: get values
head(sent_syuzhet, n = 100)
head(sent_bing, n = 100)
head(sent_afinn, n = 100)
head(sent_nrc, n = 100)

#3: descriptive analysis
mean(sent_syuzhet)
summary(sent_syuzhet)
mean(sent_afinn)
summary(sent_afinn)

plot(
  sent_syuzhet, 
  type="h", 
  main="Example Plot of Speech", 
  xlab = "Speech Time", 
  ylab= "Emotional Valence"
  )

#4: nrc dictionary
cat_nrc <- get_nrc_sentiment(stop_UNGD)
angry_toks <- which(cat_nrc$anger>0)
stop_UNGD[angry_toks]

#table of categories in emotions
pander::pandoc.table(cat_nrc[1:10, 1:8], split.table = Inf)

#table of negative vs positive
pander::pandoc.table(cat_nrc[1:10, 9:10], split.table = Inf)

#graph of categories in emotions in percentages graph shows what kind of emotions they use in the first speech
barplot(
  sort(colSums(prop.table(cat_nrc[, 1:8]))), 
  horiz = TRUE, 
  cex.names = 0.7, 
  las = 1, 
  main = "Emotions in UN speech", xlab="Percentage"
  )
```

```{r}
head(HR_dfm)
head(HR_dfm_total)
```

Data Frame of human rights variables in UNGDC

```{r}
#creating a data frame 
Human.Rights_HR <- convert(HR_dfm_total, to = "data.frame")

#converting documentID into two columns - country and year
HR_counts <- Human.Rights_HR %>%
  separate(document, c("country", "year"), "_")

#year as numeric
HR_counts$year <- as.numeric(HR_counts$year)
head(HR_counts)
HR_counts <- plyr::rename(HR_counts, c("human_rights_total"="HR"))
```

```{r}
head(HR_counts)
```


```{r}
#Merge total HR dictionary counts with the MergeNA_PTS_ungd_1976 data set

colnames(HR_counts)[colnames(HR_counts)=="country"] <- "MergeCountry"
colnames(HR_counts)[colnames(HR_counts)=="year"] <- "Year"
head(HR_counts)

colnames(merge_HHRRcounts)[colnames(merge_HHRRcounts)=="MergeCountry"] <- "MergeCountry"
head(merge_HHRRcounts)

merge_HHRRcounts %>%
      group_by(MergeCountry) %>%
      summarise(n = n())

HR_counts %>%
      group_by(MergeCountry) %>%
      summarise(n = n())

merge_HRdict_counts <- merge(merge_HHRRcounts, HR_counts, by = c('MergeCountry','Year'), all=TRUE)

head(merge_HRdict_counts)
#merged dataset with both dictionaries: HHRRterm and HRdict
```


#Sentiment Analysis Regression

## Model 1. Relation between changes in PTS and sentiment of features within the bing (binary) sentiment dictionary in UNGD speeches

Linear regression model between changes in PTS (State Department) and mentions of the "Human Rights" concept in UNGD speeches (1976 - 2018)

```{r}
Modelbing_S <- lm (HR ~ PTS_S + PTS_S_ch + PTS_S*PTS_S_ch, data = merge_HRdict_counts)
screenreg(Modelbing_S)

Modelbing_A <- lm (HR ~ PTS_A + PTS_A_ch + PTS_A*PTS_A_ch, data = merge_HRdict_counts)
screenreg(Modelbing_A)

Modelbing_H <- lm (HR ~ PTS_H + PTS_H_ch + PTS_H*PTS_H_ch, data = merge_HRdict_counts)
screenreg(Modelbing_H)
```

#Sentiment Analysis Regression

## Model 1 (baseline). Relation between changes in PTS and sentiment of features within the bing (binary) sentiment dictionary in UNGD speeches

Linear regression model between changes in PTS (State Department) and mentions of the "Human Rights" concept in UNGD speeches (1976 - 2018)

```{r}
ModelHRdict_S <- lm (HR ~ PTS_S + PTS_S_ch + PTS_S*PTS_S_ch, data = merge_HRdict_counts)
screenreg(ModelHRdict_S)

ModelHRdict_A <- lm (HR ~ PTS_A + PTS_A_ch + PTS_A*PTS_A_ch, data = merge_HRdict_counts)
screenreg(ModelHRdict_A)

ModelHRdict_H <- lm (HR ~ PTS_H + PTS_H_ch + PTS_H*PTS_H_ch, data = merge_HRdict_counts)
screenreg(ModelHRdict_H)
```

## Model 2(all sentiment dictionaries). Relation between changes in PTS and sentiment of features within the bing (binary) sentiment dictionary in UNGD speeches

```{r}

regression
reg HHRR changeinPTS PTS_year PTS_year * changeinPTS, 
reg HHRR changeinPTS PTS_year PTS_year * changeinPTS, clustered errors
reg HHRR changeinPTS PTS_year PTS_year * changeinPTS, time-fixed effects, country-fixed effects, clustered errors


